trigger:
  branches:
    include:
      - main

stages:
  - stage: DeployACI
    displayName: Deploy to ACI
    jobs:
      - job: Deploy
        displayName: Deploy to ACI
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
          - task: Docker@2
            displayName: 'Build Docker image'
            inputs:
              repository: 'mycontainer'
              command: 'build'
              Dockerfile: '$(Build.SourcesDirectory)/CI-CD/Dockerfile'
              buildContext: '$(Build.SourcesDirectory)/'
          
          - task: Docker@2
            displayName: 'Build and Push Docker image'
            inputs:
              containerRegistry: 'TestDevOpsProject'  # Replace with the name of your Azure Container Registry
              repository: 'mycontainer'
              command: 'buildAndPush'
              Dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
          
          - task: AzureCLI@2
            displayName: 'Deploy to ACI'
            inputs:
              azureSubscription: 'Azure for Students'  # Replace with your Azure subscription connection name
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az container create --resource-group devops_project --name mycontainer --image testdevopsproject.azurecr.io/mycontainer:$(Build.BuildId) --dns-name-label testdevopsproject --ports 80
